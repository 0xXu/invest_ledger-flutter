# 认证系统重新设计

## 🔄 设计变更

### 原有设计问题
- 支持"跳过登录"的离线模式
- 认证状态管理分散
- 用户体验不一致
- 安全性不足

### 新设计原则
- **强制登录**: 必须登录才能使用应用
- **统一认证**: 集中的认证状态管理
- **邮箱验证**: 强制邮箱验证流程
- **用户友好**: 清晰的状态提示和错误处理

## 🏗️ 新架构组件

### 1. 认证状态管理 (`AuthState`)
```dart
enum AuthStatus {
  initial,        // 初始状态
  checking,       // 检查登录状态中
  authenticated,  // 已认证
  unauthenticated,// 未认证
  emailNotVerified, // 邮箱未验证
}
```

### 2. 认证服务 (`AuthService`)
- 统一的认证操作接口
- 自动监听认证状态变化
- 集中的错误处理
- Riverpod 状态管理集成

### 3. 认证守卫 (`AuthGuard`)
- 保护需要登录的页面
- 自动重定向到登录页面
- 处理邮箱验证状态
- 显示加载状态

## 🔐 认证流程

### 注册流程
1. 用户填写邮箱和密码
2. 系统发送验证邮件
3. 显示邮箱验证页面
4. 用户点击邮件链接验证
5. 验证成功后可以登录

### 登录流程
1. 用户输入邮箱和密码
2. 检查邮箱是否已验证
3. 验证成功后进入主应用
4. 未验证则显示验证提示

### 密码重置流程
1. 用户点击"忘记密码"
2. 输入邮箱地址
3. 系统发送重置邮件
4. 用户通过邮件重置密码

## 🛡️ 安全特性

### 密码要求
- 最少6位字符
- 必须包含字母和数字
- 实时验证提示

### 邮箱验证
- 注册后强制验证邮箱
- 支持重新发送验证邮件
- 未验证无法使用应用

### 会话管理
- 自动检测登录状态
- 会话过期自动跳转登录
- 安全的登出处理

## 🎨 用户界面

### 登录页面特性
- 统一的登录/注册界面
- 实时表单验证
- 友好的错误提示
- 忘记密码功能

### 邮箱验证页面
- 清晰的验证说明
- 重新发送验证邮件
- 切换账户选项
- 自动状态检测

### 加载状态
- 操作过程中的加载指示
- 网络状态检查
- 优雅的错误处理

## 🔧 技术实现

### 状态管理
```dart
// 全局认证状态
final authServiceProvider = StateNotifierProvider<AuthService, AuthState>((ref) {
  return AuthService();
});

// 在组件中使用
final authState = ref.watch(authServiceProvider);
final authService = ref.read(authServiceProvider.notifier);
```

### 路由保护
```dart
// 使用 AuthGuard 保护路由
ShellRoute(
  builder: (context, state, child) => AuthGuard(child: MainLayout(child: child)),
  routes: [...],
)
```

### 认证操作
```dart
// 登录
await authService.signInWithEmail(
  email: email,
  password: password,
);

// 注册
await authService.signUpWithEmail(
  email: email,
  password: password,
);

// 登出
await authService.signOut();
```

## 📱 用户体验改进

### 自动化处理
- 自动检测登录状态
- 自动跳转到合适页面
- 自动处理认证状态变化

### 错误处理
- 友好的错误信息
- 网络错误提示
- 操作失败重试

### 状态反馈
- 实时加载状态
- 操作成功提示
- 清晰的状态指示

## 🚀 部署配置

### Supabase 设置
1. 在 Supabase 项目中启用邮箱认证
2. 配置邮件模板
3. 设置重定向 URL
4. 启用 RLS 策略

### 应用配置
1. 配置 `.env` 文件
2. 设置 Supabase URL 和 API Key
3. 运行代码生成
4. 测试认证流程

## 🔍 测试建议

### 功能测试
- [ ] 注册新账户
- [ ] 邮箱验证流程
- [ ] 登录已验证账户
- [ ] 忘记密码功能
- [ ] 登出功能

### 边界测试
- [ ] 网络断开时的行为
- [ ] 无效邮箱格式
- [ ] 弱密码处理
- [ ] 重复注册处理

### 用户体验测试
- [ ] 加载状态显示
- [ ] 错误信息清晰度
- [ ] 页面跳转流畅性
- [ ] 状态持久化

## 📋 迁移清单

### 已完成
- ✅ 创建新的认证状态管理
- ✅ 实现 AuthService 和 AuthGuard
- ✅ 重新设计登录页面
- ✅ 更新路由配置
- ✅ 移除离线模式支持

### 待完成
- [ ] 测试完整认证流程
- [ ] 优化错误处理
- [ ] 添加更多安全特性
- [ ] 完善用户体验

## 🎯 下一步

1. **配置 Supabase 项目**
   - 执行数据库脚本
   - 配置认证设置
   - 测试邮件发送

2. **测试认证流程**
   - 注册新账户
   - 验证邮箱
   - 测试登录

3. **优化用户体验**
   - 改进错误提示
   - 添加更多状态反馈
   - 优化页面跳转

通过这次重新设计，应用现在具有了更安全、更一致的认证系统，为用户提供了更好的体验！
