# 邮箱验证码系统

## 🎯 系统概述

新的认证系统使用邮箱验证码而不是邮件链接，提供更好的用户体验：

### 注册流程
1. **填写信息** → 用户输入邮箱和密码
2. **创建账户** → 系统创建用户账户
3. **发送验证码** → 向邮箱发送6位数字验证码
4. **输入验证码** → 用户在应用内输入验证码
5. **验证成功** → 账户激活，自动登录

### 密码重置流程
1. **忘记密码** → 用户点击"忘记密码"
2. **输入邮箱** → 输入需要重置的邮箱
3. **发送验证码** → 向邮箱发送6位数字验证码
4. **输入验证码** → 验证身份
5. **设置新密码** → 输入新密码完成重置

## 🎨 用户界面特性

### 验证码输入页面
- **6位数字输入框** - 每个数字一个输入框
- **自动跳转** - 输入数字后自动跳转到下一个框
- **自动验证** - 输入完成后自动验证
- **倒计时重发** - 60秒倒计时后可重新发送
- **友好提示** - 清晰的说明和错误提示

### 密码重置页面
- **新密码输入** - 支持显示/隐藏密码
- **密码确认** - 确保两次输入一致
- **强度验证** - 检查密码强度要求
- **实时验证** - 输入时实时检查格式

## 🔧 技术实现

### 验证码发送
```dart
// 注册验证码
await authService.sendSignUpOTP(email);

// 密码重置验证码
await authService.sendPasswordResetOTP(email);
```

### 验证码验证
```dart
// 验证注册验证码
await authService.verifySignUpOTP(
  email: email,
  token: verificationCode,
);

// 验证密码重置验证码并重置密码
await authService.resetPasswordWithOTP(
  email: email,
  token: verificationCode,
  newPassword: newPassword,
);
```

### 路由配置
```dart
// 验证码页面
GoRoute(
  path: '/auth/verification',
  builder: (context, state) {
    final extra = state.extra as Map<String, dynamic>;
    return VerificationCodeScreen(
      email: extra['email'],
      type: extra['type'] == 'signup' 
        ? VerificationType.signup 
        : VerificationType.passwordReset,
    );
  },
),

// 重置密码页面
GoRoute(
  path: '/auth/reset-password',
  builder: (context, state) {
    final extra = state.extra as Map<String, dynamic>;
    return ResetPasswordScreen(
      email: extra['email'],
      token: extra['token'],
    );
  },
),
```

## 📱 用户体验优化

### 验证码输入体验
- **自动聚焦** - 页面打开时自动聚焦第一个输入框
- **智能跳转** - 输入数字后自动跳转到下一个框
- **删除回退** - 删除时自动跳转到上一个框
- **点击选中** - 点击输入框时选中所有内容
- **完成验证** - 输入完成后自动开始验证

### 错误处理
- **验证失败** - 自动清空输入框并聚焦第一个
- **网络错误** - 显示友好的错误提示
- **重试机制** - 支持重新发送验证码
- **超时处理** - 验证码过期提示

### 状态反馈
- **发送状态** - 显示验证码发送状态
- **验证状态** - 显示验证进度
- **倒计时显示** - 重发按钮倒计时
- **成功提示** - 操作成功的明确反馈

## 🛡️ 安全特性

### 验证码安全
- **6位数字** - 足够的安全强度
- **有效期限** - 验证码有时间限制
- **单次使用** - 验证码使用后失效
- **重发限制** - 防止频繁发送

### 密码安全
- **强度要求** - 至少6位，包含字母和数字
- **确认验证** - 两次输入必须一致
- **实时检查** - 输入时实时验证格式
- **安全传输** - 使用HTTPS加密传输

## 🔄 与 Supabase 集成

### 配置要求
1. **启用邮箱认证** - 在 Supabase 项目中启用
2. **配置邮件模板** - 自定义验证码邮件模板
3. **设置 OTP 类型** - 配置 signup 和 recovery 类型
4. **邮件服务** - 确保邮件发送服务正常

### API 调用
```dart
// 发送验证码
await supabase.auth.resend(
  type: OtpType.signup,
  email: email,
);

// 验证验证码
await supabase.auth.verifyOTP(
  type: OtpType.signup,
  email: email,
  token: token,
);
```

## 📋 测试清单

### 注册流程测试
- [ ] 输入有效邮箱和密码
- [ ] 验证码发送成功
- [ ] 验证码输入界面正常
- [ ] 正确验证码验证成功
- [ ] 错误验证码处理正确
- [ ] 重发验证码功能正常

### 密码重置测试
- [ ] 忘记密码功能可用
- [ ] 验证码发送到正确邮箱
- [ ] 验证码验证成功
- [ ] 新密码设置成功
- [ ] 新密码登录正常

### 用户体验测试
- [ ] 输入框自动跳转
- [ ] 倒计时显示正确
- [ ] 错误提示清晰
- [ ] 成功反馈及时
- [ ] 页面跳转流畅

## 🎯 优势总结

### 相比邮件链接的优势
1. **无需跳转** - 用户无需离开应用
2. **体验流畅** - 整个流程在应用内完成
3. **响应快速** - 验证码比邮件链接更快
4. **移动友好** - 特别适合移动设备使用
5. **安全可靠** - 验证码有时效性和单次使用限制

### 用户体验提升
1. **操作简单** - 只需输入6位数字
2. **视觉清晰** - 每个数字独立显示
3. **反馈及时** - 实时状态更新
4. **错误友好** - 清晰的错误提示和恢复机制

通过这个验证码系统，用户可以享受更加流畅和安全的认证体验！
